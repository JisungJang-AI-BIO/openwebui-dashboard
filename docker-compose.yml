services:
  # ─── Open WebUI (CUDA + SSO) ────────────────────────────────
  open-webui:
    image: ghcr.io/open-webui/open-webui:cuda
    container_name: open-webui
    restart: unless-stopped
    ports:
      - "127.0.0.1:${OPENWEBUI_PORT:-10085}:8080"
    volumes:
      - open-webui-data:/app/backend/data
    networks:
      - webui-db-net
    env_file:
      - .env
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ─── Dashboard Backend (FastAPI) ────────────────────────────
  dashboard-backend:
    build: ./dashboard/backend
    container_name: dashboard-backend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${DASHBOARD_BACKEND_PORT:-10086}:8000"
    networks:
      - webui-db-net
    environment:
      - POSTGRES_USER=${DB_USER:-webui_user}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME:-webui}
      - POSTGRES_HOST=${DB_HOST:-webui-db}
      - POSTGRES_PORT=${DB_PORT:-5432}
      - AUTH_MODE=${DASHBOARD_AUTH_MODE:-mock}
      - ADMIN_USERS=${DASHBOARD_ADMIN_USERS:-jisung.jang}
    depends_on:
      open-webui:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ─── Dashboard Frontend (React → nginx) ─────────────────────
  dashboard-frontend:
    build: ./dashboard/frontend
    container_name: dashboard-frontend
    restart: unless-stopped
    ports:
      - "127.0.0.1:${DASHBOARD_FRONTEND_PORT:-10087}:80"
    networks:
      - webui-db-net
    depends_on:
      - dashboard-backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  webui-db-net:
    external: true
    name: openwebui-db_default

volumes:
  open-webui-data:
    name: open-webui-data
